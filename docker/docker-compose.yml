# docker-compose.yml
# This docker-compose file sets up a local environment for running Ollama with LiteLLM as a proxy,
# along with Chroma for vector storage and Neo4j for graph database storage.
services:
  # The Ollama service running the local LLM
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - rag_net

    #if you have an NVIDIA GPU and want to use it with Ollama, uncomment the following lines:
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # Helper service to pull models into the shared Ollama volume on startup
  model-puller:
    image: alpine/curl:latest
    container_name: model-puller
    depends_on:
      - ollama
    command: >
      sh -c "
        echo 'Waiting for Ollama to start...';
        while ! curl -s http://ollama:11434 > /dev/null; do
          sleep 1;
        done;
        echo 'Ollama is up! Pulling models...';
        curl http://ollama:11434/api/pull -d '{ \"name\": \"llama3\" }';
        curl http://ollama:11434/api/pull -d '{ \"name\": \"all-minilm\" }';
        echo 'Model pulling complete.';
      "
    networks:
      - rag_net
    restart: on-failure

  # The LiteLLM Proxy to mimic the Azure OpenAI API
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: litellm-proxy
    depends_on:
      - ollama
    ports:
      - "4000:4000" # <-- PORT CHANGED to avoid conflict with Chroma
    volumes:
      - ./config.yaml:/config.yaml
    networks:
      - rag_net
    command: ["--config", "/config.yaml", "--port", "4000"] # <-- PORT CHANGED
    restart: always

  # NEW: Chroma DB for vector storage
  chroma-db:
    image: chromadb/chroma:latest
    container_name: chroma-db
    ports:
      - "8000:8000" # Chroma's default API port
    volumes:
      - chroma_data:/chroma/.chroma/
    networks:
      - rag_net
    restart: always

  # NEW: Neo4j for graph database storage
  # neo4j-db:
    # image: neo4j:5-community
    # container_name: neo4j-db
    # ports:
    #   - "7474:7474" # Neo4j Browser UI
    #   - "7687:7687" # Bolt protocol for drivers
    # volumes:
    #   - neo4j_data:/data
    # environment:
    #   # ⚠️ IMPORTANT: Change the password below! - At least 8 characters long, with at least one uppercase letter, one lowercase letter, one number, and one special character.
    #   - NEO4J_AUTH=neo4j/1@3$QwRy
    # networks:
    #   - rag_net
    # restart: always

volumes:
  ollama_data:
  chroma_data: # Data persistence for Chroma
  # neo4j_data:  # Data persistence for Neo4j

networks:
  rag_net: # Renamed network for clarity
    driver: bridge
